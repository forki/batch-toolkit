<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Tutorial 1: Using the DSL
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="A toolkit to simplify interacting with Azure Batch Services"/>
    <meta name="author" content="John Azariah"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/batch-toolkit/content/style.css" />
    <script type="text/javascript" src="/batch-toolkit/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/johnazariah/batch-toolkit">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/batch-toolkit/index.html">Azure.Batch.Toolkit</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Tutorial-1-Using-the-DSL" class="anchor" href="#Tutorial-1-Using-the-DSL">Tutorial 1: Using the DSL</a></h1>
<p>The purpose of this tutorial is to use the Toolkit DSL to define a very simple workload and submit it.</p>
<p>When you are done, you should have:</p>
<ol>
<li>An understanding of the basic object model of workloads</li>
<li>An understanding of some operations that are supported by the toolkit</li>
<li>An experience of having interacted with the Batch Service and submitted your first workload</li>
</ol>
<p>Remember, you should have run the <a href="tutorial0.html">Getting Set Up</a> tutorial first!</p>
<h4><a name="Reference-and-Namespace" class="anchor" href="#Reference-and-Namespace">Reference and Namespace</a></h4>
<p>The first thing to do is to reference the toolkit. <em>Note that it is packaged in <strong>Batch.Toolkit.dll</strong></em></p>
<p>The next thing is to open the namespace. <em>Note that this is <strong>Batch.Toolkit</strong></em></p>
<p>The DSL is found in the</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;Batch.Toolkit.dll&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">Toolkit</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 3)" onmouseover="showTip(event, 'fs1', 3)" class="i">Batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 4)" onmouseover="showTip(event, 'fs2', 4)" class="i">Toolkit</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 5)" onmouseover="showTip(event, 'fs3', 5)" class="i">DSL</span>
</code></pre></td>
</tr>
</table>
<h4><a name="Object-Model-Command" class="anchor" href="#Object-Model-Command">Object Model: Command</a></h4>
<p>A <code>Command</code> is the basic unit of execution. This is typically the name of your executable file or batch script.</p>
<p>The object model defined in the toolkit has two kinds of commands:</p>
<ul>
<li>A <code>SimpleCommand</code> is just a string with the command line of the executable you want to run. You can have spaces and static arguments passed to the executable name as part of a simple command</li>
<li>A <code>ParametrizedCommand</code> pairs a command line <em>template</em> with a collection of parameter names, which can be replaced by the toolkit with a range of values. Surround the parameter name with <code>%</code> in the command line to identify it as a placeholder.</li>
</ul>
<p>The following <code>let</code> creates an instance of a <code>ParametrizedCommand</code> through the DSL shortcut <code>:parametric_cmd</code>.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="i">helloUserCommand</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="f">``:parametric_cmd``</span> <span class="s">&quot;echo &#39;Hello %user%&#39;&quot;</span> <span onmouseout="hideTip(event, 'fs6', 8)" onmouseover="showTip(event, 'fs6', 8)" class="i">``:with_params``</span> [<span class="s">&quot;user&quot;</span>]
</code></pre></td>
</tr>
</table>
<p><em>Note that the double backticks around <code>:parametric_cmd</code> - and around all the DSL keywords - are required.</em></p>
<p>As you probably imagine, this command will eventually be expressed as a different command-line for each value that we might bind to <code>user</code>.</p>
<h4><a name="Object-Model-WorkloadUnitTemplate" class="anchor" href="#Object-Model-WorkloadUnitTemplate">Object Model: WorkloadUnitTemplate</a></h4>
<p>We can compose commands into more complex objects in the toolkit, but the one that is ultimately useful for us is the <code>WorkloadUnitTemplate</code> object.</p>
<p>For now, let's skip discussing the intermediate objects and build one from our command using the <code>:unit_template</code> "keyword" from the DSL.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs7', 9)" onmouseover="showTip(event, 'fs7', 9)" class="i">workloadUnitTemplate</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="f">``:unit_template``</span> 
        <span onmouseout="hideTip(event, 'fs9', 11)" onmouseover="showTip(event, 'fs9', 11)" class="i">``:admin``</span> <span class="k">false</span> 
        <span onmouseout="hideTip(event, 'fs10', 12)" onmouseover="showTip(event, 'fs10', 12)" class="i">``:main``</span> 
            [
                <span onmouseout="hideTip(event, 'fs11', 13)" onmouseover="showTip(event, 'fs11', 13)" class="f">``:do``</span> <span onmouseout="hideTip(event, 'fs4', 14)" onmouseover="showTip(event, 'fs4', 14)" class="i">helloUserCommand</span>
            ] 
        <span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">``:finally``</span>
            []
        <span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="i">``:files``</span> 
            []
</code></pre></td>
</tr>
</table>
<p>The key components of the <code>:unit_template</code> are:</p>
<ol>
<li>The <code>:admin</code> flag: This specifies if the commands in the template require administrative privileges to run.</li>
<li>The <code>:main</code> block: This is a list of <code>Command</code>s which are composed together to run. We only have one here, which says that we want to <code>:do</code> the <code>helloUserCommand</code> specified earlier without any error handling.</li>
<li>The <code>:finally</code> block: This is a list of <code>Command</code>s which we require to be run at the end of the main block. We won't need to run anything here for this simple workload.</li>
<li>The <code>:files</code> block: This is a list of <code>FileInfo</code> objects representing files we want to upload in order to run the workload successfully. We don't need any files for this simple workload.</li>
</ol>
<h4><a name="Object-Model-Workload" class="anchor" href="#Object-Model-Workload">Object Model: Workload</a></h4>
<p>Now, let's specify a <code>Workload</code>, which will represent a Batch Job. We can do this by using the <code>:workload</code> DSL command.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 17)" onmouseover="showTip(event, 'fs14', 17)" class="i">workload</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs15', 18)" onmouseover="showTip(event, 'fs15', 18)" class="f">``:workload``</span>
        <span onmouseout="hideTip(event, 'fs16', 19)" onmouseover="showTip(event, 'fs16', 19)" class="i">``:unit_templates``</span> 
            [
                <span onmouseout="hideTip(event, 'fs7', 20)" onmouseover="showTip(event, 'fs7', 20)" class="i">workloadUnitTemplate</span> 
            ]
        <span onmouseout="hideTip(event, 'fs13', 21)" onmouseover="showTip(event, 'fs13', 21)" class="i">``:files``</span> 
            []
        <span onmouseout="hideTip(event, 'fs17', 22)" onmouseover="showTip(event, 'fs17', 22)" class="i">``:arguments``</span> 
            [
                <span onmouseout="hideTip(event, 'fs18', 23)" onmouseover="showTip(event, 'fs18', 23)" class="f">``:range``</span> <span class="s">&quot;user&quot;</span> <span onmouseout="hideTip(event, 'fs19', 24)" onmouseover="showTip(event, 'fs19', 24)" class="i">``:over``</span> [<span class="s">&quot;John&quot;</span>; <span class="s">&quot;Ivan&quot;</span>; <span class="s">&quot;Pablo&quot;</span>]
            ]
</code></pre></td>
</tr>
</table>
<p>A <code>:workload</code> is associated with the following:</p>
<ol>
<li>A <code>:unit_templates</code> block: This is a collection of <code>WorkloadUnitTemplate</code>s associated with this <code>Workload</code>. Our example uses the single template we defined earlier.</li>
<li>A <code>:files</code> block: This is a list of <code>FileInfo</code> objects which represents the files common to all the instances of all the <code>WorkloadUnitTemplate</code>s in this workload.</li>
<li>An <code>:arguments</code> block: This is a collection of named <code>:range</code>s, which specify the set of values for each parameter.</li>
</ol>
<p>A new instance of each <code>WorkloadUnitTemplate</code> is created and bound to each unique set of arguments, and these instances form the Tasks in our Batch Job.</p>
<p>In this example, the <code>Workload</code> will be expressed into a single Batch Job with three tasks: one for each value of <code>user</code> specified in the <code>:range</code>.</p>
<p>Now we are done with the definition, and all we need to do is to run the workload on the Batch Service.</p>
<h4><a name="Object-Model-Configuration-Objects" class="anchor" href="#Object-Model-Configuration-Objects">Object Model : Configuration Objects</a></h4>
<p>Interacting with the Batch service requires us to pass some credentials to in order to obtain a set of correctly configured context objects against which we can operate.</p>
<p>The toolkit has defined a few configuration objects (and helper methods to read these objects in from JSON files) so we can easily write applications and manage the credentials sensibly.</p>
<ul>
<li>BatchConfiguration</li>
</ul>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs20', 25)" onmouseover="showTip(event, 'fs20', 25)" class="t">BatchConfiguration</span> <span class="o">=</span> {
    <span onmouseout="hideTip(event, 'fs21', 26)" onmouseover="showTip(event, 'fs21', 26)" class="i">BatchAccountName</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 27)" onmouseover="showTip(event, 'fs22', 27)" class="t">string</span>
    <span onmouseout="hideTip(event, 'fs23', 28)" onmouseover="showTip(event, 'fs23', 28)" class="i">BatchAccountKey</span>  <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 29)" onmouseover="showTip(event, 'fs22', 29)" class="t">string</span>
    <span onmouseout="hideTip(event, 'fs24', 30)" onmouseover="showTip(event, 'fs24', 30)" class="i">BatchAccountRegion</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 31)" onmouseover="showTip(event, 'fs22', 31)" class="t">string</span>
    <span onmouseout="hideTip(event, 'fs25', 32)" onmouseover="showTip(event, 'fs25', 32)" class="i">BatchServiceUri</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 33)" onmouseover="showTip(event, 'fs22', 33)" class="t">string</span>
}
</code></pre></td>
</tr>
</table>
<ul>
<li>StorageConfiguration</li>
</ul>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs26', 34)" onmouseover="showTip(event, 'fs26', 34)" class="t">StorageConfiguration</span> <span class="o">=</span> {
    <span onmouseout="hideTip(event, 'fs27', 35)" onmouseover="showTip(event, 'fs27', 35)" class="i">StorageAccountName</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 36)" onmouseover="showTip(event, 'fs22', 36)" class="t">string</span>
    <span onmouseout="hideTip(event, 'fs28', 37)" onmouseover="showTip(event, 'fs28', 37)" class="i">StorageAccountKey</span>  <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 38)" onmouseover="showTip(event, 'fs22', 38)" class="t">string</span>
    <span onmouseout="hideTip(event, 'fs29', 39)" onmouseover="showTip(event, 'fs29', 39)" class="i">StagingContainerName</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs22', 40)" onmouseover="showTip(event, 'fs22', 40)" class="t">string</span>
}
</code></pre></td>
</tr>
</table>
<p>There is also a helper function <code>readConfig&lt;'a&gt;</code> which can construct an <code>'a</code> from an appropriately written JSON file.
We can now build these objects from our JSON files like so:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> (<span onmouseout="hideTip(event, 'fs30', 41)" onmouseover="showTip(event, 'fs30', 41)" class="i">batchConfig</span>, <span onmouseout="hideTip(event, 'fs31', 42)" onmouseover="showTip(event, 'fs31', 42)" class="i">storageConfig</span>) <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs32', 43)" onmouseover="showTip(event, 'fs32', 43)" class="i">succeed</span> {        
        <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs33', 44)" onmouseover="showTip(event, 'fs33', 44)" class="i">batchConfig</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 45)" onmouseover="showTip(event, 'fs34', 45)" class="f">readConfig</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs20', 46)" onmouseover="showTip(event, 'fs20', 46)" class="t">BatchConfiguration</span><span class="o">&gt;</span>(<span class="s">&quot;batch-config.json&quot;</span>)
        <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs35', 47)" onmouseover="showTip(event, 'fs35', 47)" class="i">storageConfig</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 48)" onmouseover="showTip(event, 'fs34', 48)" class="f">readConfig</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs26', 49)" onmouseover="showTip(event, 'fs26', 49)" class="t">StorageConfiguration</span><span class="o">&gt;</span>(<span class="s">&quot;storage-config.json&quot;</span>)
        <span class="k">return</span> (<span onmouseout="hideTip(event, 'fs33', 50)" onmouseover="showTip(event, 'fs33', 50)" class="i">batchConfig</span>, <span onmouseout="hideTip(event, 'fs35', 51)" onmouseover="showTip(event, 'fs35', 51)" class="i">storageConfig</span>)
    } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs36', 52)" onmouseover="showTip(event, 'fs36', 52)" class="f">getOrThrow</span>
</code></pre></td>
</tr>
</table>
<h4><a name="Object-Model-Pool-Object" class="anchor" href="#Object-Model-Pool-Object">Object Model : Pool Object</a></h4>
<p>Azure Batch is remarkable in its approach to providing a Batch execution context in that it separates the concern of Resource Allocation from the concern of Job Management. We have focussed in this sample on defining the Job in a user-centric way, but in order to run the job, we require a Pool.</p>
<p>Azure Batch allows us to specify an automatic pool, or to re-use a named pool. In our example, we'll use a named pool and the Toolkit infrastructure will create one for us if it doesn't exist already.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs37', 53)" onmouseover="showTip(event, 'fs37', 53)" class="i">pool</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 54)" onmouseover="showTip(event, 'fs38', 54)" class="p">NamedPool</span> { <span class="i">NamedPoolName</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs39', 55)" onmouseover="showTip(event, 'fs39', 55)" class="p">PoolName</span> <span class="s">&quot;sample-pool&quot;</span>; <span class="i">NamedPoolSpecification</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs40', 56)" onmouseover="showTip(event, 'fs40', 56)" class="t">PoolOperations</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs41', 57)" onmouseover="showTip(event, 'fs41', 57)" class="i">GetDefaultPoolSpecification</span> }        
</code></pre></td>
</tr>
</table>
<p>Now we can run the workload we've created, and the task representing the <code>helloUserCommand</code> for each respective user will be executed on a virtual machine managed by the pool.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs14', 58)" onmouseover="showTip(event, 'fs14', 58)" class="i">workload</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs42', 59)" onmouseover="showTip(event, 'fs42', 59)" class="t">WorkloadOperations</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 60)" onmouseover="showTip(event, 'fs43', 60)" class="f">RunWorkloadOnPool</span> <span onmouseout="hideTip(event, 'fs30', 61)" onmouseover="showTip(event, 'fs30', 61)" class="i">batchConfig</span> <span onmouseout="hideTip(event, 'fs31', 62)" onmouseover="showTip(event, 'fs31', 62)" class="i">storageConfig</span> <span onmouseout="hideTip(event, 'fs37', 63)" onmouseover="showTip(event, 'fs37', 63)" class="i">pool</span>
</code></pre></td>
</tr>
</table>
<h4><a name="Finishing-touches" class="anchor" href="#Finishing-touches">Finishing touches</a></h4>
<p>We can, in fact, make a utility function to run <em>any</em> workload against our configuration files, and re-use that for all our samples:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span class="t">SampleCommon</span> <span class="o">=</span>
    <span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 64)" onmouseover="showTip(event, 'fs1', 64)" class="i">Batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 65)" onmouseover="showTip(event, 'fs2', 65)" class="i">Toolkit</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs40', 66)" onmouseover="showTip(event, 'fs40', 66)" class="i">PoolOperations</span>
    <span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 67)" onmouseover="showTip(event, 'fs1', 67)" class="i">Batch</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 68)" onmouseover="showTip(event, 'fs2', 68)" class="i">Toolkit</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs42', 69)" onmouseover="showTip(event, 'fs42', 69)" class="i">WorkloadOperations</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs44', 70)" onmouseover="showTip(event, 'fs44', 70)" class="f">runSampleWorkload</span> <span onmouseout="hideTip(event, 'fs45', 71)" onmouseover="showTip(event, 'fs45', 71)" class="i">workload</span> <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs46', 72)" onmouseover="showTip(event, 'fs46', 72)" class="i">pool</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 73)" onmouseover="showTip(event, 'fs38', 73)" class="p">NamedPool</span> { <span class="i">NamedPoolName</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs39', 74)" onmouseover="showTip(event, 'fs39', 74)" class="p">PoolName</span> <span class="s">&quot;sample-pool&quot;</span>; <span class="i">NamedPoolSpecification</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs41', 75)" onmouseover="showTip(event, 'fs41', 75)" class="i">GetDefaultPoolSpecification</span> }        
        <span class="k">let</span> (<span onmouseout="hideTip(event, 'fs33', 76)" onmouseover="showTip(event, 'fs33', 76)" class="i">batchConfig</span>, <span onmouseout="hideTip(event, 'fs35', 77)" onmouseover="showTip(event, 'fs35', 77)" class="i">storageConfig</span>) <span class="o">=</span> 
            <span onmouseout="hideTip(event, 'fs32', 78)" onmouseover="showTip(event, 'fs32', 78)" class="i">succeed</span> {        
                <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs33', 79)" onmouseover="showTip(event, 'fs33', 79)" class="i">batchConfig</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 80)" onmouseover="showTip(event, 'fs34', 80)" class="f">readConfig</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs20', 81)" onmouseover="showTip(event, 'fs20', 81)" class="t">BatchConfiguration</span><span class="o">&gt;</span>(<span class="s">&quot;batch-config.json&quot;</span>)
                <span class="k">let!</span> <span onmouseout="hideTip(event, 'fs35', 82)" onmouseover="showTip(event, 'fs35', 82)" class="i">storageConfig</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 83)" onmouseover="showTip(event, 'fs34', 83)" class="f">readConfig</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs26', 84)" onmouseover="showTip(event, 'fs26', 84)" class="t">StorageConfiguration</span><span class="o">&gt;</span>(<span class="s">&quot;storage-config.json&quot;</span>)
                <span class="k">return</span> (<span onmouseout="hideTip(event, 'fs33', 85)" onmouseover="showTip(event, 'fs33', 85)" class="i">batchConfig</span>, <span onmouseout="hideTip(event, 'fs35', 86)" onmouseover="showTip(event, 'fs35', 86)" class="i">storageConfig</span>)
            } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs36', 87)" onmouseover="showTip(event, 'fs36', 87)" class="f">getOrThrow</span>

        <span onmouseout="hideTip(event, 'fs45', 88)" onmouseover="showTip(event, 'fs45', 88)" class="i">workload</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs43', 89)" onmouseover="showTip(event, 'fs43', 89)" class="f">RunWorkloadOnPool</span> <span onmouseout="hideTip(event, 'fs33', 90)" onmouseover="showTip(event, 'fs33', 90)" class="i">batchConfig</span> <span onmouseout="hideTip(event, 'fs35', 91)" onmouseover="showTip(event, 'fs35', 91)" class="i">storageConfig</span> <span onmouseout="hideTip(event, 'fs46', 92)" onmouseover="showTip(event, 'fs46', 92)" class="i">pool</span>
</code></pre></td>
</tr>
</table>
<h4><a name="The-whole-enchilada" class="anchor" href="#The-whole-enchilada">The whole enchilada</a></h4>
<p>Using this utility function, we can focus <em>purely</em> on defining our workload in our main sample.</p>
<p>The whole sample looks like this:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span onmouseout="hideTip(event, 'fs47', 93)" onmouseover="showTip(event, 'fs47', 93)" class="t">Sample1</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs48', 94)" onmouseover="showTip(event, 'fs48', 94)" class="i">helloUserCommand</span> <span class="o">=</span> 
        <span onmouseout="hideTip(event, 'fs5', 95)" onmouseover="showTip(event, 'fs5', 95)" class="f">``:parametric_cmd``</span> <span class="s">&quot;echo &#39;Hello %user%&#39;&quot;</span> <span onmouseout="hideTip(event, 'fs6', 96)" onmouseover="showTip(event, 'fs6', 96)" class="i">``:with_params``</span> [<span class="s">&quot;user&quot;</span>]
    
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs49', 97)" onmouseover="showTip(event, 'fs49', 97)" class="i">workloadUnitTemplate</span> <span class="o">=</span> 
        <span onmouseout="hideTip(event, 'fs8', 98)" onmouseover="showTip(event, 'fs8', 98)" class="f">``:unit_template``</span> 
            <span onmouseout="hideTip(event, 'fs9', 99)" onmouseover="showTip(event, 'fs9', 99)" class="i">``:admin``</span> <span class="k">false</span> 
            <span onmouseout="hideTip(event, 'fs10', 100)" onmouseover="showTip(event, 'fs10', 100)" class="i">``:main``</span> 
                [
                    <span onmouseout="hideTip(event, 'fs11', 101)" onmouseover="showTip(event, 'fs11', 101)" class="f">``:do``</span> <span onmouseout="hideTip(event, 'fs48', 102)" onmouseover="showTip(event, 'fs48', 102)" class="i">helloUserCommand</span>
                ] 
            <span onmouseout="hideTip(event, 'fs12', 103)" onmouseover="showTip(event, 'fs12', 103)" class="i">``:finally``</span>
                []
            <span onmouseout="hideTip(event, 'fs13', 104)" onmouseover="showTip(event, 'fs13', 104)" class="i">``:files``</span> 
                []

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs50', 105)" onmouseover="showTip(event, 'fs50', 105)" class="i">workload</span> <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs15', 106)" onmouseover="showTip(event, 'fs15', 106)" class="f">``:workload``</span>
            <span onmouseout="hideTip(event, 'fs16', 107)" onmouseover="showTip(event, 'fs16', 107)" class="i">``:unit_templates``</span> 
                [
                    <span onmouseout="hideTip(event, 'fs49', 108)" onmouseover="showTip(event, 'fs49', 108)" class="i">workloadUnitTemplate</span> 
                ]
            <span onmouseout="hideTip(event, 'fs13', 109)" onmouseover="showTip(event, 'fs13', 109)" class="i">``:files``</span> 
                []
            <span onmouseout="hideTip(event, 'fs17', 110)" onmouseover="showTip(event, 'fs17', 110)" class="i">``:arguments``</span> 
                [
                    <span onmouseout="hideTip(event, 'fs18', 111)" onmouseover="showTip(event, 'fs18', 111)" class="f">``:range``</span> <span class="s">&quot;user&quot;</span> <span onmouseout="hideTip(event, 'fs19', 112)" onmouseover="showTip(event, 'fs19', 112)" class="i">``:over``</span> [<span class="s">&quot;John&quot;</span>; <span class="s">&quot;Ivan&quot;</span>; <span class="s">&quot;Pablo&quot;</span>]
                ]

    <span onmouseout="hideTip(event, 'fs50', 113)" onmouseover="showTip(event, 'fs50', 113)" class="i">workload</span> <span class="o">|&gt;</span> <span class="i">runSampleWorkload</span>
</code></pre></td>
</tr>
</table>
<p>Just <em>one</em> of the 30 lines of code above is the act of running the workload. The remaining code is <em>entirely</em> focussed on defining the workload itself.</p>
<h4><a name="Summary" class="anchor" href="#Summary">Summary</a></h4>
<p>We were able to model a workload with a parametric sweep and execute it against Azure Batch using a <em>little</em> DSL in the Toolkit.</p>
<p>The key take-aways are:</p>
<ol>
<li>It's useful to be able to take a workload-centric view of the problem, and abstract away the interaction with the Azure Batch Service (via the Azure Batch Client SDK).</li>
<li>We have an object model that allows us to think about <em>composing</em> smaller pieces together to make more complex workloads.</li>
<li>We have a little DSL that allows us to hide even the creation of the object model instances in a pleasant (if idiosyncratic) manner.</li>
<li>Specifically, this model (and the DSL) supports a way to sweep a set of values over a set of parameters to build a set of batch tasks.</li>
</ol>
<p>Hope you have fun playing around with the DSL. You'll find the other supported operations <a href="https://github.com/johnazariah/batch-toolkit/blob/master/src/Azure.Batch.Toolkit/DSL.fs">here</a>.</p>
<p>Enjoy!</p>

<div class="tip" id="fs1">namespace Batch</div>
<div class="tip" id="fs2">namespace Batch.Toolkit</div>
<div class="tip" id="fs3">module DSL<br /><br />from Batch.Toolkit</div>
<div class="tip" id="fs4">val helloUserCommand : Command<br /><br />Full name: Tutorial1.helloUserCommand</div>
<div class="tip" id="fs5">val ( :parametric_cmd ) : command:string -&gt; &#39;a -&gt; parameters:string list -&gt; Command<br /><br />Full name: Batch.Toolkit.DSL.( :parametric_cmd )</div>
<div class="tip" id="fs6">val ( :with_params ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :with_params )</div>
<div class="tip" id="fs7">val workloadUnitTemplate : WorkloadUnitTemplate<br /><br />Full name: Tutorial1.workloadUnitTemplate</div>
<div class="tip" id="fs8">val ( :unit_template ) : &#39;a -&gt; runAsAdmin:bool -&gt; &#39;b -&gt; mainBlock:CommandWithErrorHandler list -&gt; &#39;c -&gt; finallyBlock:Command list -&gt; &#39;d -&gt; localFiles:System.IO.FileInfo list -&gt; WorkloadUnitTemplate<br /><br />Full name: Batch.Toolkit.DSL.( :unit_template )</div>
<div class="tip" id="fs9">val ( :admin ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :admin )</div>
<div class="tip" id="fs10">val ( :main ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :main )</div>
<div class="tip" id="fs11">val ( :do ) : c:Command -&gt; CommandWithErrorHandler<br /><br />Full name: Batch.Toolkit.DSL.( :do )</div>
<div class="tip" id="fs12">val ( :finally ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :finally )</div>
<div class="tip" id="fs13">val ( :files ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :files )</div>
<div class="tip" id="fs14">val workload : WorkloadSpecification<br /><br />Full name: Tutorial1.workload</div>
<div class="tip" id="fs15">val ( :workload ) : &#39;a -&gt; workloadUnitTemplates:WorkloadUnitTemplate list -&gt; &#39;b -&gt; commonFiles:System.IO.FileInfo list -&gt; &#39;c -&gt; arguments:seq&lt;string * Set&lt;string&gt;&gt; -&gt; WorkloadSpecification<br /><br />Full name: Batch.Toolkit.DSL.( :workload )</div>
<div class="tip" id="fs16">val ( :unit_templates ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :unit_templates )</div>
<div class="tip" id="fs17">val ( :arguments ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :arguments )</div>
<div class="tip" id="fs18">val ( :range ) : parameterName:&#39;a -&gt; &#39;b -&gt; parameterValues:&#39;c list -&gt; &#39;a * Set&lt;&#39;c&gt; (requires comparison)<br /><br />Full name: Batch.Toolkit.DSL.( :range )</div>
<div class="tip" id="fs19">val ( :over ) : &#39;a option<br /><br />Full name: Batch.Toolkit.DSL.( :over )</div>
<div class="tip" id="fs20">type BatchConfiguration =<br />&#160;&#160;{BatchAccountName: string;<br />&#160;&#160;&#160;BatchAccountKey: string;<br />&#160;&#160;&#160;BatchAccountRegion: string;<br />&#160;&#160;&#160;BatchServiceUri: string;}<br /><br />Full name: Tutorial1.BatchConfiguration</div>
<div class="tip" id="fs21">BatchConfiguration.BatchAccountName: string</div>
<div class="tip" id="fs22">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs23">BatchConfiguration.BatchAccountKey: string</div>
<div class="tip" id="fs24">BatchConfiguration.BatchAccountRegion: string</div>
<div class="tip" id="fs25">BatchConfiguration.BatchServiceUri: string</div>
<div class="tip" id="fs26">type StorageConfiguration =<br />&#160;&#160;{StorageAccountName: string;<br />&#160;&#160;&#160;StorageAccountKey: string;<br />&#160;&#160;&#160;StagingContainerName: string;}<br /><br />Full name: Tutorial1.StorageConfiguration</div>
<div class="tip" id="fs27">StorageConfiguration.StorageAccountName: string</div>
<div class="tip" id="fs28">StorageConfiguration.StorageAccountKey: string</div>
<div class="tip" id="fs29">StorageConfiguration.StagingContainerName: string</div>
<div class="tip" id="fs30">val batchConfig : BatchConfiguration<br /><br />Full name: Tutorial1.batchConfig</div>
<div class="tip" id="fs31">val storageConfig : StorageConfiguration<br /><br />Full name: Tutorial1.storageConfig</div>
<div class="tip" id="fs32">val succeed : SuccessOrFailureBuilder<br /><br />Full name: Batch.Toolkit.SuccessOrFailure.succeed</div>
<div class="tip" id="fs33">val batchConfig : BatchConfiguration</div>
<div class="tip" id="fs34">val readConfig : config:string -&gt; SuccessOrFailure&lt;&#39;a&gt;<br /><br />Full name: Batch.Toolkit.Common.readConfig</div>
<div class="tip" id="fs35">val storageConfig : StorageConfiguration</div>
<div class="tip" id="fs36">val getOrThrow : _arg1:SuccessOrFailure&lt;&#39;a&gt; -&gt; &#39;a<br /><br />Full name: Batch.Toolkit.SuccessOrFailure.getOrThrow</div>
<div class="tip" id="fs37">val pool : Pool<br /><br />Full name: Tutorial1.pool</div>
<div class="tip" id="fs38">Multiple items<br />union case Pool.NamedPool: NamedPool -&gt; Pool<br /><br />--------------------<br />type NamedPool =<br />&#160;&#160;{NamedPoolName: PoolName;<br />&#160;&#160;&#160;NamedPoolSpecification: PoolSpecification;}<br /><br />Full name: Batch.Toolkit.NamedPool</div>
<div class="tip" id="fs39">Multiple items<br />union case PoolName.PoolName: string -&gt; PoolName<br /><br />--------------------<br />type PoolName = | PoolName of string<br /><br />Full name: Batch.Toolkit.PoolName</div>
<div class="tip" id="fs40">module PoolOperations<br /><br />from Batch.Toolkit</div>
<div class="tip" id="fs41">val GetDefaultPoolSpecification : PoolSpecification<br /><br />Full name: Batch.Toolkit.PoolOperations.GetDefaultPoolSpecification</div>
<div class="tip" id="fs42">module WorkloadOperations<br /><br />from Batch.Toolkit</div>
<div class="tip" id="fs43">val RunWorkloadOnPool : batchConfiguration:BatchConfiguration -&gt; storageConfiguration:StorageConfiguration -&gt; pool:Pool -&gt; workload:WorkloadSpecification -&gt; unit<br /><br />Full name: Batch.Toolkit.WorkloadOperations.RunWorkloadOnPool</div>
<div class="tip" id="fs44">val runSampleWorkload : workload:WorkloadSpecification -&gt; unit<br /><br />Full name: Tutorial1.SampleCommon.runSampleWorkload</div>
<div class="tip" id="fs45">val workload : WorkloadSpecification</div>
<div class="tip" id="fs46">val pool : Pool</div>
<div class="tip" id="fs47">module Sample1<br /><br />from Tutorial1</div>
<div class="tip" id="fs48">val helloUserCommand : Command<br /><br />Full name: Tutorial1.Sample1.helloUserCommand</div>
<div class="tip" id="fs49">val workloadUnitTemplate : WorkloadUnitTemplate<br /><br />Full name: Tutorial1.Sample1.workloadUnitTemplate</div>
<div class="tip" id="fs50">val workload : WorkloadSpecification<br /><br />Full name: Tutorial1.Sample1.workload</div>

        </div>
        <div class="span3">
          <img src="/batch-toolkit/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Azure.Batch.Toolkit</li>
            <li><a href="/batch-toolkit/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/Batch.Toolkit">Get Library via NuGet</a></li>
            <li><a href="http://github.com/johnazariah/batch-toolkit">Source Code on GitHub</a></li>
            <li><a href="/batch-toolkit/license.html">License</a></li>
            <li><a href="/batch-toolkit/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Tutorials</li>
            <li><a href="/batch-toolkit/tutorial0.html">Getting Set Up</a></li>
            <li><a href="/batch-toolkit/tutorial1.html">Use the DSL to Submit Workload</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/batch-toolkit/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/johnazariah/batch-toolkit"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
